<html>
    <style>
    body{
        font-family: "Trebuchet MS", Helvetica, sans-serif;
    }
    .overlay-box{
        border: thin black solid;
        position: absolute;
        cursor: default;
    }
    #hover-div{
        z-index:1001;
        position:absolute;
        display:none;
    }
    #diva-wrapper{
        float:right;
        width:50%;
        height:100%;
    }
    #editor{
        float:left;
        width:50%;
        height:100%;
        top:0%;
    }
    #file-upload{
        z-index:5;
        border:thin black solid;
        position:fixed;
        background: #DDDDDD;
        padding:10px;
        border-radius:10px;
        height:auto;
        width:auto;
        top:30px;
        left:30px;
    }
    .clear{
        clear:both;
    }
    .meiFile{
        border-radius:10px;
        border:thin black solid;
        padding:5px;
    }
    </style>
    <link rel="stylesheet" href="/diva.js/build/css/diva.min.css" />
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" ></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="/diva.js/build/js/diva.min.js" type="text/javascript"></script>
    <script src="https://x2js.googlecode.com/hg/xml2json.js"></script>
    <script src="/diva.js/build/js/plugins/highlight.js"></script>
    <script src="meiEditor.js"></script>
    <script src="/ace/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://eligrey.com/demos/FileSaver.js/FileSaver.js"></script>
    <script>
    var dv;
    var editor;
    var meiEditor;

    $(function() 
    {
        //various jQueryUI designators
        $("#file-upload").draggable();
        $("#file-list").sortable();
        $("#file-list").disableSelection();
        $("#file-list").on("sortstop", function(e, ui){
            fileList = $(".meiFile");
            newOrder = [];
            numberOfFiles = $(".meiFile").length;
            for(curFileIndex = 0; curFileIndex < numberOfFiles; curFileIndex++)
            {
                newOrder.push(fileList[curFileIndex].id);
            }
            meiEditor.reorderFiles(newOrder);
        });

        //when a new file is uploaded
        $('#fileInput').change(function(e)
        { 
            var reader = new FileReader();
            reader.file = this.files[0];

            //when the file is loaded as text
            reader.onload = function(e) 
            { 
                fileName = this.file.name
                meiEditor.addPage(this.result, fileName);
                //$("#file-list").html($("#file-list").html()+"<span class='meiFile'><span class='meiName'>"+this.file.name+"</span><span class='meiLoad' onclick='loadPage(\""+this.file.name+"\")'>Load</span><span class='meiSave' onclick='savePage(\""+this.file.name+"\")'>Save</span></span>"); //add the file to the GUI    
                $("#file-list").html($("#file-list").html()+"<div class='meiFile' id='"+fileName+"'>"+fileName+"<button class='meiLoad' onclick='loadPage(\""+fileName+"\")'>Load</button><button class='meiSave' onclick='savePage(\""+fileName+"\")'>Save</button></div>"); //add the file to the GUI
            };
            reader.readAsText(this.files[0]);
        });
        $('#diva-wrapper').diva(
        {//create the diva wrapper
            contained: true,
            enableAutoHeight: true,
            fixedHeightGrid: false,
            iipServerURL: "http://132.206.14.136:8000/fcgi-bin/iipsrv.fcgi",
            objectData: "imagesOut.json",
            imageDir: "/opt/stgall",
            enableHighlight: true
        });
        dv = $('#diva-wrapper').data('diva');
        editor = ace.edit("editor"); //create the ACE editor
        editor.setTheme("ace/theme/ambiance");
        editor.getSession().setMode("ace/mode/xml");
        meiEditor = new AceMeiEditor(editor);
    });

    function loadPage(pageName)
    {
        meiEditor.changeActivePage(pageName);
    }

    function savePage(pageName)
    {
        meiEditor.savePageToClient(pageName);
    }

    function changeFileListVisibility(willBeVisible)
    {
        if(willBeVisible)
        {
            $("#file-upload-contents-wrapper").css('display', 'block');
            $("#file-upload-minimized-wrapper").css('display', 'none');
        } else 
        {
            previousWidth = $("#file-upload").width();
            $("#file-upload-minimized-wrapper").css('display', 'block');
            $("#file-upload-contents-wrapper").css('display', 'none');
            $("#file-upload").width(previousWidth);
        }
    }

    </script>
    <div id="file-upload">
        <div id="file-upload-contents-wrapper">
            <input type="file" value="Add a new file" id="fileInput">
            <div id="file-list">Files loaded:<br></div>
            <button onclick="meiEditor.createHighlights()">Update DIVA</button>
            <button onclick="changeFileListVisibility(false)" style="float:right;">Minimize</button>
        </div>
        <div id="file-upload-minimized-wrapper" style="display:none;">
            <span id="file-list">Files loaded:</span>
            <button onclick="changeFileListVisibility(true)" style="float:right;">Maximize</button>
        </div>
    </div>
    <div id="editor"></div>
    <div id="diva-wrapper"></div>
    <div class="clear"></div>
    <span id="hover-div"></span>
</html> 