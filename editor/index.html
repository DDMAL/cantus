<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cantus - MEI Editor</title>

        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//cantus.simssa.ca/static/css/bootstrap-theme.css">
        <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
        <link rel="stylesheet" href="meix.js/css/meiEditor.css" />
        <link rel="stylesheet" href="divaEditor.css" />

        <!--foreign libraries -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <!--local libraries -->
        <!--<script src="diva.js/build/js/diva.js" type="text/javascript"></script>
        <script src="diva.js/build/js/utils.js" type="text/javascript"></script>
        <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script>-->
        <script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>

        <script src="meix.js/js/lib/require.js"></script>
        <script src="meix.js/js/local/meiEditorPreloader.js"></script>
    </head>
    <body>
        <div id="mei-editor"></div>
        <div id="diva-wrapper"></div>
        <div id="loadingScreen">
            <h2>Please choose a manuscript to load:</h2>
            <select id='manuscriptSelect'>
                <option value='000'> Sankt Gallen 390 demo </option>
            </select><br>
            <button id='manuscriptSubmit'>Load</button>
        </div>
    </body>
    <script>
        function editorInit(divaImageLoc, jsonLoc)
        {
            jsonFile = 'imagesOut.json';
            //create the diva wrapper and editor

            $('#diva-wrapper').diva(
            {
                adaptivePadding: 0,
                contained: true,
                enableAutoTitle: false,
                enableAutoHeight: false,
                enableAutoWidth: false,   
                enableCanvas: false,        
                enableDownload: false,
                enableFullscreen: false,
                enableGridIcon: false,
                fixedHeightGrid: false,
                iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
                objectData: jsonLoc,
                imageDir: divaImageLoc,
                enableHighlight: true,
                viewerWidthPadding: 0,
                viewerHeightPadding: 0
            });

            divaInstance = $('#diva-wrapper').data('diva');

            var element = "#mei-editor";
            var options = 
            {
                'meiEditorLocation': 'meix.js/',
                'validatorLink': 'meix.js/validation/', 
                'xmllintLocation': 'meix.js/js/lib/xmllint.js',
                'xmllintServer': 'http://cantus.simssa.ca/nodeLint/',
                'divaInstance': divaInstance, 
                'jsonFileLocation': jsonFile,
                'navbarClass': 'navbar navbar-default'
            };
            var plugins = ["meiEditorDivaManager.js"];

            var meiEditor = new MeiEditor(element, options, plugins);
        }

        var currentSite = document.URL.split('/')[2]; //0 is http:, 1 is blank, 2 is subdomain + domain
        $.get("http://" + currentSite + "/manuscripts/", undefined, function(e){
            for(curManuscriptIndex in e)
            { 
                $("#manuscriptSelect").append("<option value='" + e[curManuscriptIndex].siglum_slug + "'>" + e[curManuscriptIndex].name + "</option>");
            }
        });

        $("#manuscriptSubmit").on('click', function()
        {
            var manuscriptNumber = $($("#manuscriptSelect").find(":selected")).attr('value');
            if(manuscriptNumber == '000')
            {
                editorInit("/srv/images/meixBkup", 'imagesOut.json');
            }
            else
            {
                editorInit("/srv/images/cantus/" + manuscriptNumber, "http://" + currentSite + "/static/" + manuscriptNumber + ".json");
            }
        });

        window.onload = function()
        {
            //here so I can wait for the diva objects to actually exist
            $(window).on('allReady', function(e){
                $(".diva-tools").addClass('diva-toolbar navbar navbar-default');
                var divaOuterDiff = $("#1-diva-outer").outerHeight() - $("#1-diva-outer").height();
                var divaOuterWidthDiff = $("#1-diva-outer").outerHeight() - $("#1-diva-outer").height();
                $(".diva-toolbar").height($("#openPages").offset().top);
                $(".diva-toolbar").width($("#diva-wrapper").width());
                $("#diva-wrapper").offset({'top': $("#topbar").outerHeight()});
                $("#diva-wrapper").height(window.innerHeight - $("#topbar").outerHeight());
                $(".diva-outer").height(window.innerHeight - $("#topbar").outerHeight() - divaOuterDiff);
                $("#diva-wrapper").width(window.innerWidth/2 - divaOuterWidthDiff);
                $(".diva-toolbar").offset({'top': 0, 'left': $("#diva-wrapper").offset().left});
                $(".diva-page-nav").css({
                    'padding-right': '0em'
                });
                $(".diva-buttons-label").css({
                    'padding': '7px',
                    'padding-left': '15px',
                    'border-top-width': '0px',
                    'border-bottom-width': '0px'
                });
                $(".diva-input").css({
                    'padding': '5px'
                });
                $(".diva-page-label").css({
                    'margin-top': '5px'
                });
                $("#loadingScreen").animate({
                    'height': '30px',
                    'line-height': '30px',
                    'opacity': '0'
                }, {
                    duration: 300,
                    complete: function(){$("#loadingScreen").remove();}
                });
            });
        };
    </script>
</html> 