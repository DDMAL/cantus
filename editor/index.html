<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cantus - MEI Editor</title>

        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//cantus.simssa.ca/static/css/bootstrap-theme.css">
        <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
        <link rel="stylesheet" href="meix.js/css/meiEditor.css" />
        <link rel="stylesheet" href="meix.js/css/zoneDisplay.css" />
        <link rel="stylesheet" href="divaEditor.css" />
        <link rel="Shortcut Icon" href="/favicon.ico">

        <!--foreign libraries -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <!--local libraries -->
        <script src="diva.js/build/js/diva.js" type="text/javascript"></script>
        <script src="diva.js/build/js/utils.js" type="text/javascript"></script>
        <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script>
        <!--<script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>-->

        <script src="meix.js/js/lib/require.js"></script>
        <script src="meix.js/js/local/meiEditorPreloader.js"></script>
    </head>
    <body>
        <div id="mei-editor"></div>
        <div id="diva-wrapper"></div>
        <div id="loadingScreen">
            <h2>Please choose a manuscript to load:</h2>
            <select id='manuscriptSelect'>
                <option value='000'> Sankt Gallen 390 demo </option>
            </select><br>
            <button id='manuscriptSubmit'>Load</button>
        </div>
    </body>
    <script>
        var docArr = document.URL.split('/'); //0 is http:, 1 is blank, 2 is subdomain + domain, length - 1 is folio to jump to if it's defined
        var currentSite = docArr[2];
        var siglum_slug = docArr[docArr.length - 1].split('?')[1];
        var meiEditor;
        var divaInstance;

        function editorInit(divaImageLoc, jsonLoc, currentSite, sig_slug)
        {
            $("#loadingScreen").html("The Cantus MEI Editor is loading...");

            //create the diva wrapper and editor
            $('#diva-wrapper').diva(
            {
                adaptivePadding: 0,
                enableAutoTitle: false,
                enableAutoHeight: false,
                enableAutoWidth: false,   
                enableCanvas: false,        
                enableDownload: false,
                enableFullscreen: false,
                enableGridIcon: false,
                fixedHeightGrid: false,
                iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
                objectData: jsonLoc,
                imageDir: divaImageLoc,
                enableHighlight: true,
                viewerWidthPadding: 0,
                viewerHeightPadding: 0
            });

            divaInstance = $('#diva-wrapper').data('diva');

            var element = "#mei-editor";
            var options = 
            {
                'initializeWithFile': 'csg-0390_015.mei',
                'meiEditorLocation': 'meix.js/',
                'validatorLink': 'meix.js/validation/', 
                'xmllintLocation': 'meix.js/js/lib/xmllint.js',
                'divaInstance': divaInstance, 
                'oneToOneMEI': true,
                'navbarClass': 'navbar navbar-default',
                'pageTitle': 'Cantus Ultimus',
                'siglum_slug': sig_slug,
                'currentSite': currentSite
            };

            var plugins = ["meix.js/js/local/plugins/meiEditorZoneDisplay.js"];

            meiEditor = new MeiEditor(element, options, plugins);
        }

        $(window).on('meiEditorLoaded', function(e){
            meiEditor = $("#mei-editor").data('AceMeiEditor');
            $(".diva-tools").addClass('diva-toolbar navbar navbar-default');
            $("#loadingScreen").animate({
                'height': '30px',
                'line-height': '30px',
                'opacity': '0'
            }, {
                duration: 300,
                complete: function(){$("#loadingScreen").remove();}
            });

            meiEditor.events.subscribe("NewZone", function(pageRef, prevID, nextID, curID)
            {
                var toInsert = pageRef.parsed.createElement('neume');
                toInsert.setAttribute('xml:id', genUUID());
                toInsert.setAttribute('name', "Unnamed");
                toInsert.setAttribute('facs', curID);

                var prevIdx, prevNeume, nextIdx, nextNeume;
                if(nextID)
                {
                    nextNeume = pageRef.parsed.querySelectorAll('neume[*|facs=' + nextID + ']')[0];
                    nextIdx = Array.prototype.indexOf.call(nextNeume.parentElement.childNodes, nextNeume);
                }

                if(prevID)
                {
                    prevNeume = pageRef.parsed.querySelectorAll('neume[*|facs=' + prevID + ']')[0];
                    prevIdx = Array.prototype.indexOf.call(prevNeume.parentElement.childNodes, prevNeume);
                }

                if (nextIdx && prevIdx && (Math.abs(nextIdx - prevIdx) > 2))
                {
                    meiEditor.localWarn('Tried to insert a neume between two that were not adjacent.');
                }        

                if (nextID)
                {
                    indentNode = nextNeume.parentElement.childNodes[nextIdx - 1].cloneNode(false);

                    nextNeume.parentElement.insertBefore(toInsert, nextNeume);
                    nextNeume.parentElement.insertBefore(indentNode, nextNeume);
                }

                else 
                {
                    indentNode = prevNeume.parentElement.childNodes[prevIdx - 1].cloneNode(false);

                    inserted = prevNeume.insertAdjacentElement("afterEnd", toInsert);
                    inserted.parentElement.insertBefore(indentNode, inserted);
                }    

                rewriteAce(pageRef);

                var newZoneHandler = meiEditor.events.subscribe('ZonesWereUpdated', function()
                {
                    meiEditor.selectHighlight("#" + curID);
                    meiEditor.events.unsubscribe(newZoneHandler);
                });


            });
        });
        
        if(siglum_slug !== undefined && siglum_slug !== "") //if there is a siglum_slug appended to the URL 
        {
            editorInit("/srv/images/cantus/" + siglum_slug, "http://" + currentSite + "/static/" + siglum_slug + ".json", currentSite, siglum_slug); //start the editor based off what it's supposed to be
        }
        else
        {
            if (!currentSite.match("127.0.0.1"))
            { //if we're not development
                $.ajax({
                    url: "http://" + currentSite + "/manuscripts/",
                    success: function(e)
                    { //we're on production, make an API call to /manuscripts/
                        for(curManuscriptIndex in e)
                        { 
                            //add an option for each manuscript
                            $("#manuscriptSelect").append("<option value='" + e[curManuscriptIndex].siglum_slug + "'>" + e[curManuscriptIndex].name + "</option>");
                        }
                    },
                    error: function(e)
                    {
                        console.log("Couldn't find the manuscripts. Just loading demo Diva.");
                    }
                });
            }

            $("#manuscriptSubmit").on('click', function()
            {
                //when the user selects a manuscript to load
                var siglum_slug = $($("#manuscriptSelect").find(":selected")).attr('value');
                if(siglum_slug == '000')
                {
                    //if they're loading the six-page demo, that's static and the json file is included
                    editorInit("/srv/images/meixBkup", 'csg0390demo.json', currentSite, 'ch-sgs-390');
                }
                else
                {
                    //grab it off the server
                    editorInit("/srv/images/cantus/" + siglum_slug, "http://" + currentSite + "/static/" + siglum_slug + ".json", currentSite, siglum_slug);
                    
                    //make it look like we changed URLs
                    window.history.replaceState("","", document.URL + "?" + siglum_slug);
                }
            });
        }
    </script>
</html> 
